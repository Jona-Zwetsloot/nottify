import*as e from"./token-types.js";import{StringType as t}from"./token-types.js";import a from"./debug.js";import*as r from"./strtok3.js";import{uint8ArrayToString as n,stringToUint8Array as i}from"./uint8array-extras.js";const s=e=>class extends Error{constructor(t){super(t),this.name=e}};class o extends(s("UnexpectedFileContentError")){constructor(e,t){super(t),this.fileType=e}toString(){return`${this.name} (FileType: ${this.fileType}): ${this.message}`}}class c extends(s("FieldDecodingError")){}class d extends(s("InternalParserError")){}const l=e=>class extends o{constructor(t){super(e,t)}};function h(e,t,a){return!!(e[t]&1<<a)}function u(e,t,a,r){let n=t;if("utf-16le"===r){for(;0!==e[n]||0!==e[n+1];){if(n>=a)return a;n+=2}return n}for(;0!==e[n];){if(n>=a)return a;n++}return n}function m(e,a){if(255===e[0]&&254===e[1])return m(e.subarray(2),a);if("utf-16le"===a&&254===e[0]&&255===e[1]){if(1&e.length)throw new c("Expected even number of octets for 16-bit unicode string");return m(function(e){const t=e.length;if(1&t)throw new c("Buffer length must be even");for(let a=0;a<t;a+=2){const t=e[a];e[a]=e[a+1],e[a+1]=t}return e}(e),a)}return new t(e.length,a).get(e,0)}const g=/^[\x21-\x7eÂ©][\x20-\x7e\x00()]{3}/,p={len:4,get:(e,t)=>{const a=n(e.slice(t,t+p.len),"latin1");if(!a.match(g))throw new c(`FourCC contains invalid characters: ${function(e){const t=[];for(let a=0,r=e.length;a<r;a++){const r=Number(e.charCodeAt(a)).toString(16);t.push(1===r.length?`0${r}`:r)}return t.join(" ")}(a)} "${a}"`);return a},put:(e,t,a)=>{const r=i(a);if(4!==r.length)throw new d("Invalid length");return e.set(r,t),t+4}};class k{constructor(e,t,a){this.metadata=e,this.tokenizer=t,this.options=a}}var f,T,I;!function(e){e[e.Other=0]="Other",e[e["32x32 pixels 'file icon' (PNG only)"]=1]="32x32 pixels 'file icon' (PNG only)",e[e["Other file icon"]=2]="Other file icon",e[e["Cover (front)"]=3]="Cover (front)",e[e["Cover (back)"]=4]="Cover (back)",e[e["Leaflet page"]=5]="Leaflet page",e[e["Media (e.g. label side of CD)"]=6]="Media (e.g. label side of CD)",e[e["Lead artist/lead performer/soloist"]=7]="Lead artist/lead performer/soloist",e[e["Artist/performer"]=8]="Artist/performer",e[e.Conductor=9]="Conductor",e[e["Band/Orchestra"]=10]="Band/Orchestra",e[e.Composer=11]="Composer",e[e["Lyricist/text writer"]=12]="Lyricist/text writer",e[e["Recording Location"]=13]="Recording Location",e[e["During recording"]=14]="During recording",e[e["During performance"]=15]="During performance",e[e["Movie/video screen capture"]=16]="Movie/video screen capture",e[e["A bright coloured fish"]=17]="A bright coloured fish",e[e.Illustration=18]="Illustration",e[e["Band/artist logotype"]=19]="Band/artist logotype",e[e["Publisher/Studio logotype"]=20]="Publisher/Studio logotype"}(f||(f={})),function(e){e[e.other=0]="other",e[e.lyrics=1]="lyrics",e[e.text=2]="text",e[e.movement_part=3]="movement_part",e[e.events=4]="events",e[e.chord=5]="chord",e[e.trivia_pop=6]="trivia_pop"}(T||(T={})),function(e){e[e.notSynchronized0=0]="notSynchronized0",e[e.mpegFrameNumber=1]="mpegFrameNumber",e[e.milliseconds=2]="milliseconds"}(I||(I={}));const y={get:(e,t)=>127&e[t+3]|e[t+2]<<7|e[t+1]<<14|e[t]<<21,len:4},b={len:10,get:(t,a)=>({fileIdentifier:new e.StringType(3,"ascii").get(t,a),version:{major:e.INT8.get(t,a+3),revision:e.INT8.get(t,a+4)},flags:{unsynchronisation:h(t,a+5,7),isExtendedHeader:h(t,a+5,6),expIndicator:h(t,a+5,5),footer:h(t,a+5,4)},size:y.get(t,a+6)})},w={len:10,get:(t,a)=>({size:e.UINT32_BE.get(t,a),extendedFlags:e.UINT16_BE.get(t,a+4),sizeOfPadding:e.UINT32_BE.get(t,a+6),crcDataPresent:h(t,a+4,31)})},S=(e,t)=>{switch(e[t]){case 0:return{encoding:"latin1"};case 1:return{encoding:"utf-16le",bom:!0};case 2:return{encoding:"utf-16le",bom:!1};default:return{encoding:"utf8",bom:!1}}},D=4,v=(t,a)=>({encoding:S(t,a),language:new e.StringType(3,"latin1").get(t,a+1)}),C=6,z=(t,a)=>{const r=v(t,a);return{encoding:r.encoding,language:r.language,timeStampFormat:e.UINT8.get(t,a+4),contentType:e.UINT8.get(t,a+5)}};var P;!function(e){e[e.text_utf8=0]="text_utf8",e[e.binary=1]="binary",e[e.external_info=2]="external_info",e[e.reserved=3]="reserved"}(P||(P={})),a("music-metadata:parser:APEv2"),a("music-metadata:parser:ID3v1");const x=["Blues","Classic Rock","Country","Dance","Disco","Funk","Grunge","Hip-Hop","Jazz","Metal","New Age","Oldies","Other","Pop","R&B","Rap","Reggae","Rock","Techno","Industrial","Alternative","Ska","Death Metal","Pranks","Soundtrack","Euro-Techno","Ambient","Trip-Hop","Vocal","Jazz+Funk","Fusion","Trance","Classical","Instrumental","Acid","House","Game","Sound Clip","Gospel","Noise","Alt. Rock","Bass","Soul","Punk","Space","Meditative","Instrumental Pop","Instrumental Rock","Ethnic","Gothic","Darkwave","Techno-Industrial","Electronic","Pop-Folk","Eurodance","Dream","Southern Rock","Comedy","Cult","Gangsta Rap","Top 40","Christian Rap","Pop/Funk","Jungle","Native American","Cabaret","New Wave","Psychedelic","Rave","Showtunes","Trailer","Lo-Fi","Tribal","Acid Punk","Acid Jazz","Polka","Retro","Musical","Rock & Roll","Hard Rock","Folk","Folk/Rock","National Folk","Swing","Fast-Fusion","Bebob","Latin","Revival","Celtic","Bluegrass","Avantgarde","Gothic Rock","Progressive Rock","Psychedelic Rock","Symphonic Rock","Slow Rock","Big Band","Chorus","Easy Listening","Acoustic","Humour","Speech","Chanson","Opera","Chamber Music","Sonata","Symphony","Booty Bass","Primus","Porn Groove","Satire","Slow Jam","Club","Tango","Samba","Folklore","Ballad","Power Ballad","Rhythmic Soul","Freestyle","Duet","Punk Rock","Drum Solo","A Cappella","Euro-House","Dance Hall","Goa","Drum & Bass","Club-House","Hardcore","Terror","Indie","BritPop","Negerpunk","Polsk Punk","Beat","Christian Gangsta Rap","Heavy Metal","Black Metal","Crossover","Contemporary Christian","Christian Rock","Merengue","Salsa","Thrash Metal","Anime","JPop","Synthpop","Abstract","Art Rock","Baroque","Bhangra","Big Beat","Breakbeat","Chillout","Downtempo","Dub","EBM","Eclectic","Electro","Electroclash","Emo","Experimental","Garage","Global","IDM","Illbient","Industro-Goth","Jam Band","Krautrock","Leftfield","Lounge","Math Rock","New Romantic","Nu-Breakz","Post-Punk","Post-Rock","Psytrance","Shoegaze","Space Rock","Trop Rock","World Music","Neoclassical","Audiobook","Audio Theatre","Neue Deutsche Welle","Podcast","Indie Rock","G-Funk","Dubstep","Garage Rock","Psybient"],N=a("music-metadata:id3v2:frame-parser"),B="latin1";function F(e){return"RX"===e?"Remix":"CR"===e?"Cover":e.match(/^\d*$/)?x[Number.parseInt(e)]:void 0}class R{constructor(e,t){this.major=e,this.warningCollector=t}readData(t,a,r){if(0===t.length)return void this.warningCollector.addWarning(`id3v2.${this.major} header has empty tag type=${a}`);const{encoding:n,bom:i}=S(t,0),s=t.length;let o=0,c=[];const d=R.getNullTerminatorLength(n);let l;switch(N(`Parsing tag type=${a}, encoding=${n}, bom=${i}`),"TXXX"!==a&&"T"===a[0]?"T*":a){case"T*":case"GRP1":case"IPLS":case"MVIN":case"MVNM":case"PCS":case"PCST":{let e;try{e=m(t.slice(1),n).replace(/\x00+$/,"")}catch(e){if(e instanceof Error){this.warningCollector.addWarning(`id3v2.${this.major} type=${a} header has invalid string value: ${e.message}`);break}throw e}switch(a){case"TMCL":case"TIPL":case"IPLS":c=R.functionList(this.splitValue(a,e));break;case"TRK":case"TRCK":case"TPOS":c=e;break;case"TCOM":case"TEXT":case"TOLY":case"TOPE":case"TPE1":case"TSRC":c=this.splitValue(a,e);break;case"TCO":case"TCON":c=this.splitValue(a,e).map((e=>function(e){const t=[];let a,r="";for(const n of e)if("string"==typeof a)if("("===n&&""===a)r+="(",a=void 0;else if(")"===n){""!==r&&(t.push(r),r="");const e=F(a);e&&t.push(e),a=void 0}else a+=n;else"("===n?a="":r+=n;return r&&(0===t.length&&r.match(/^\d*$/)&&(r=F(r)),r&&t.push(r)),t}(e))).reduce(((e,t)=>e.concat(t)),[]);break;case"PCS":case"PCST":c=this.major>=4?this.splitValue(a,e):[e],c=Array.isArray(c)&&""===c[0]?1:0;break;default:c=this.major>=4?this.splitValue(a,e):[e]}break}case"TXXX":{const e=R.readIdentifierAndData(t,o+1,s,n);c={description:e.id,text:this.splitValue(a,m(e.data,n).replace(/\x00+$/,""))};break}case"PIC":case"APIC":if(r){const e={};switch(o+=1,this.major){case 2:e.format=m(t.slice(o,o+3),"latin1"),o+=3;break;case 3:case 4:l=u(t,o,s,B),e.format=m(t.slice(o,l),B),o=l+1;break;default:throw function(e){throw new $(`Unexpected majorVer: ${e}`)}(this.major)}e.format=R.fixPictureMimeType(e.format),e.type=f[t[o]],o+=1,l=u(t,o,s,n),e.description=m(t.slice(o,l),n),o=l+d,e.data=t.slice(o,s),c=e}break;case"CNT":case"PCNT":c=e.UINT32_BE.get(t,0);break;case"SYLT":{const a=z(t,0);o+=C;const r={descriptor:"",language:a.language,contentType:a.contentType,timeStampFormat:a.timeStampFormat,syncText:[]};let n=!1;for(;o<s;){const i=R.readNullTerminatedString(t.subarray(o),a.encoding);if(o+=i.len,n){const a=e.UINT32_BE.get(t,o);o+=e.UINT32_BE.len,r.syncText.push({text:i.text,timestamp:a})}else r.descriptor=i.text,n=!0}c=r;break}case"ULT":case"USLT":case"COM":case"COMM":{const e=v(t,o);o+=D;const a=R.readNullTerminatedString(t.subarray(o),e.encoding);o+=a.len;const r=R.readNullTerminatedString(t.subarray(o),e.encoding);c={language:e.language,descriptor:a.text,text:r.text};break}case"UFID":{const e=R.readIdentifierAndData(t,o,s,B);c={owner_identifier:e.id,identifier:e.data};break}case"PRIV":{const e=R.readIdentifierAndData(t,o,s,B);c={owner_identifier:e.id,data:e.data};break}case"POPM":{l=u(t,o,s,B);const a=m(t.slice(o,l),B);o=l+1;const r=s-o;c={email:a,rating:e.UINT8.get(t,o),counter:r>=5?e.UINT32_BE.get(t,o+1):void 0};break}case"GEOB":{l=u(t,o+1,s,n);const e=m(t.slice(o+1,l),B);o=l+1,l=u(t,o,s,n);const a=m(t.slice(o,l),B);o=l+1,l=u(t,o,s,n);const r=m(t.slice(o,l),B);o=l+1;c={type:e,filename:a,description:r,data:t.slice(o,s)};break}case"WCOM":case"WCOP":case"WOAF":case"WOAR":case"WOAS":case"WORS":case"WPAY":case"WPUB":l=u(t,o+1,s,n),c=m(t.slice(o,l),B);break;case"WXXX":{l=u(t,o+1,s,n);const e=m(t.slice(o+1,l),n);o=l+("utf-16le"===n?2:1),c={description:e,url:m(t.slice(o,s),B)};break}case"WFD":case"WFED":c=m(t.slice(o+1,u(t,o+1,s,n)),n);break;case"MCDI":c=t.slice(0,s);break;default:N(`Warning: unsupported id3v2-tag-type: ${a}`)}return c}static readNullTerminatedString(e,t){let a=t.bom?2:0;const r=u(e,a,e.length,t.encoding),n=e.slice(a,r);return a="utf-16le"===t.encoding?r+2:r+1,{text:m(n,t.encoding),len:a}}static fixPictureMimeType(e){switch(e=e.toLocaleLowerCase()){case"jpg":return"image/jpeg";case"png":return"image/png"}return e}static functionList(e){const t={};for(let a=0;a+1<e.length;a+=2){const r=e[a+1].split(",");t[e[a]]=t[e[a]]?t[e[a]].concat(r):r}return t}splitValue(e,t){let a;return this.major<4?(a=t.split(/\x00/g),a.length>1?this.warningCollector.addWarning(`ID3v2.${this.major} ${e} uses non standard null-separator.`):a=t.split(/\//g)):a=t.split(/\x00/g),R.trimArray(a)}static trimArray(e){return e.map((e=>e.replace(/\x00+$/,"").trim()))}static readIdentifierAndData(e,t,a,r){const n=u(e,t,a,r),i=m(e.slice(t,n),r);return t=n+R.getNullTerminatorLength(r),{id:i,data:e.slice(t,a)}}static getNullTerminatorLength(e){return"utf-16le"===e?2:1}}class $ extends(l("id3v2")){}const E=new TextDecoder("ascii");class A{constructor(){this.tokenizer=void 0,this.id3Header=void 0,this.metadata=void 0,this.headerType=void 0,this.options=void 0}static removeUnsyncBytes(e){let t=0,a=0;for(;t<e.length-1;)t!==a&&(e[a]=e[t]),t+=255===e[t]&&0===e[t+1]?2:1,a++;return t<e.length&&(e[a++]=e[t]),e.slice(0,a)}static getFrameHeaderLength(e){switch(e){case 2:return 6;case 3:case 4:return 10;default:throw O(e)}}static readFrameFlags(e){return{status:{tag_alter_preservation:h(e,0,6),file_alter_preservation:h(e,0,5),read_only:h(e,0,4)},format:{grouping_identity:h(e,1,7),compression:h(e,1,3),encryption:h(e,1,2),unsynchronisation:h(e,1,1),data_length_indicator:h(e,1,0)}}}static readFrameData(e,t,a,r,n){const i=new R(a,n);switch(a){case 2:return i.readData(e,t.id,r);case 3:case 4:return t.flags?.format.unsynchronisation&&(e=A.removeUnsyncBytes(e)),t.flags?.format.data_length_indicator&&(e=e.slice(4,e.length)),i.readData(e,t.id,r);default:throw O(a)}}static makeDescriptionTagName(e,t){return e+(t?`:${t}`:"")}async parse(e,t,a){this.tokenizer=t,this.metadata=e,this.options=a;const r=await this.tokenizer.readToken(b);if("ID3"!==r.fileIdentifier)throw new $("expected ID3-header file-identifier 'ID3' was not found");return this.id3Header=r,this.headerType=`ID3v2.${r.version.major}`,r.flags.isExtendedHeader?this.parseExtendedHeader():this.parseId3Data(r.size)}async parseExtendedHeader(){const e=await this.tokenizer.readToken(w),t=e.size-w.len;return t>0?this.parseExtendedHeaderData(t,e.size):this.parseId3Data(this.id3Header.size-e.size)}async parseExtendedHeaderData(e,t){return await this.tokenizer.ignore(e),this.parseId3Data(this.id3Header.size-t)}async parseId3Data(t){const a=await this.tokenizer.readToken(new e.Uint8ArrayType(t));for(const e of this.parseMetadata(a))if("TXXX"===e.id)e.value&&await this.handleTag(e,e.value.text,(()=>e.value.description));else await(Array.isArray(e.value)?Promise.all(e.value.map((t=>this.addTag(e.id,t)))):this.addTag(e.id,e.value))}async handleTag(e,t,a,r=e=>e){await Promise.all(t.map((t=>this.addTag(A.makeDescriptionTagName(e.id,a(t)),r(t)))))}async addTag(e,t){await this.metadata.addTag(this.headerType,e,t)}parseMetadata(e){let t=0;const a=[];for(;t!==e.length;){const r=A.getFrameHeaderLength(this.id3Header.version.major);if(t+r>e.length){this.metadata.addWarning("Illegal ID3v2 tag length");break}const n=e.slice(t,t+r);t+=r;const i=this.readFrameHeader(n,this.id3Header.version.major),s=e.slice(t,t+i.length);t+=i.length;const o=A.readFrameData(s,i,this.id3Header.version.major,!this.options.skipCovers,this.metadata);o&&a.push({id:i.id,value:o})}return a}readFrameHeader(t,a){let r;switch(a){case 2:r={id:E.decode(t.slice(0,3)),length:e.UINT24_BE.get(t,3)},r.id.match(/[A-Z0-9]{3}/g)||this.metadata.addWarning(`Invalid ID3v2.${this.id3Header.version.major} frame-header-ID: ${r.id}`);break;case 3:case 4:r={id:E.decode(t.slice(0,4)),length:(4===a?y:e.UINT32_BE).get(t,4),flags:A.readFrameFlags(t.slice(8,10))},r.id.match(/[A-Z0-9]{4}/g)||this.metadata.addWarning(`Invalid ID3v2.${this.id3Header.version.major} frame-header-ID: ${r.id}`);break;default:throw O(a)}return r}}function O(e){throw new $(`Unexpected majorVer: ${e}`)}const U={len:12,get:(t,a)=>({chunkID:p.get(t,a),chunkSize:e.INT64_BE.get(t,a+4)})},_=a("music-metadata:parser:aiff");class L extends(l("DSDIFF")){}class M extends k{async parse(){const e=await this.tokenizer.readToken(U);if("FRM8"!==e.chunkID)throw new L("Unexpected chunk-ID");const t=(await this.tokenizer.readToken(p)).trim();if("DSD"===t)return this.metadata.setFormat("container",`DSDIFF/${t}`),this.metadata.setFormat("lossless",!0),this.readFmt8Chunks(e.chunkSize-BigInt(p.len));throw new L(`Unsupported DSDIFF type: ${t}`)}async readFmt8Chunks(e){for(;e>=U.len;){const t=await this.tokenizer.readToken(U);_(`Chunk id=${t.chunkID}`),await this.readData(t),e-=BigInt(U.len)+t.chunkSize}}async readData(t){_(`Reading data of chunk[ID=${t.chunkID}, size=${t.chunkSize}]`);const a=this.tokenizer.position;switch(t.chunkID.trim()){case"FVER":{const t=await this.tokenizer.readToken(e.UINT32_LE);_(`DSDIFF version=${t}`);break}case"PROP":if("SND "!==await this.tokenizer.readToken(p))throw new L("Unexpected PROP-chunk ID");await this.handleSoundPropertyChunks(t.chunkSize-BigInt(p.len));break;case"ID3":{const a=await this.tokenizer.readToken(new e.Uint8ArrayType(Number(t.chunkSize))),n=r.fromBuffer(a);await(new A).parse(this.metadata,n,this.options);break}case"DSD":this.metadata.format.numberOfChannels&&this.metadata.setFormat("numberOfSamples",Number(t.chunkSize*BigInt(8)/BigInt(this.metadata.format.numberOfChannels))),this.metadata.format.numberOfSamples&&this.metadata.format.sampleRate&&this.metadata.setFormat("duration",this.metadata.format.numberOfSamples/this.metadata.format.sampleRate);break;default:_(`Ignore chunk[ID=${t.chunkID}, size=${t.chunkSize}]`)}const n=t.chunkSize-BigInt(this.tokenizer.position-a);n>0&&(_(`After Parsing chunk, remaining ${n} bytes`),await this.tokenizer.ignore(Number(n)))}async handleSoundPropertyChunks(t){for(_(`Parsing sound-property-chunks, remainingSize=${t}`);t>0;){const a=await this.tokenizer.readToken(U);_(`Sound-property-chunk[ID=${a.chunkID}, size=${a.chunkSize}]`);const r=this.tokenizer.position;switch(a.chunkID.trim()){case"FS":{const t=await this.tokenizer.readToken(e.UINT32_BE);this.metadata.setFormat("sampleRate",t);break}case"CHNL":{const t=await this.tokenizer.readToken(e.UINT16_BE);this.metadata.setFormat("numberOfChannels",t),await this.handleChannelChunks(a.chunkSize-BigInt(e.UINT16_BE.len));break}case"CMPR":{const t=(await this.tokenizer.readToken(p)).trim(),a=await this.tokenizer.readToken(e.UINT8),r=await this.tokenizer.readToken(new e.StringType(a,"ascii"));"DSD"===t&&(this.metadata.setFormat("lossless",!0),this.metadata.setFormat("bitsPerSample",1)),this.metadata.setFormat("codec",`${t} (${r})`);break}case"ABSS":{const t=await this.tokenizer.readToken(e.UINT16_BE),a=await this.tokenizer.readToken(e.UINT8),r=await this.tokenizer.readToken(e.UINT8),n=await this.tokenizer.readToken(e.UINT32_BE);_(`ABSS ${t}:${a}:${r}.${n}`);break}case"LSCO":{const t=await this.tokenizer.readToken(e.UINT16_BE);_(`LSCO lsConfig=${t}`);break}default:_(`Unknown sound-property-chunk[ID=${a.chunkID}, size=${a.chunkSize}]`),await this.tokenizer.ignore(Number(a.chunkSize))}const n=a.chunkSize-BigInt(this.tokenizer.position-r);n>0&&(_(`After Parsing sound-property-chunk ${a.chunkSize}, remaining ${n} bytes`),await this.tokenizer.ignore(Number(n))),t-=BigInt(U.len)+a.chunkSize,_(`Parsing sound-property-chunks, remainingSize=${t}`)}if(this.metadata.format.lossless&&this.metadata.format.sampleRate&&this.metadata.format.numberOfChannels&&this.metadata.format.bitsPerSample){const e=this.metadata.format.sampleRate*this.metadata.format.numberOfChannels*this.metadata.format.bitsPerSample;this.metadata.setFormat("bitrate",e)}}async handleChannelChunks(e){_(`Parsing channel-chunks, remainingSize=${e}`);const t=[];for(;e>=p.len;){const a=await this.tokenizer.readToken(p);_(`Channel[ID=${a}]`),t.push(a),e-=BigInt(p.len)}return _(`Channels: ${t.join(", ")}`),t}}export{L as DsdiffContentParseError,M as DsdiffParser};export default null;