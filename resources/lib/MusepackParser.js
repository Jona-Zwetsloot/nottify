import e from"./debug.js";import*as t from"./token-types.js";import{StringType as a,UINT8 as r}from"./token-types.js";import*as i from"./strtok3.js";import{EndOfStreamError as s}from"./strtok3.js";import{uint8ArrayToString as n,stringToUint8Array as o}from"./uint8array-extras.js";const c=e=>class extends Error{constructor(t){super(t),this.name=e}};class d extends(c("UnexpectedFileContentError")){constructor(e,t){super(t),this.fileType=e}toString(){return`${this.name} (FileType: ${this.fileType}): ${this.message}`}}class l extends(c("FieldDecodingError")){}class h extends(c("InternalParserError")){}const u=e=>class extends d{constructor(t){super(e,t)}};function p(e,t,a){return!!(e[t]&1<<a)}function g(e,t,a,r){let i=t;if("utf-16le"===r){for(;0!==e[i]||0!==e[i+1];){if(i>=a)return a;i+=2}return i}for(;0!==e[i];){if(i>=a)return a;i++}return i}function m(e,t){if(255===e[0]&&254===e[1])return m(e.subarray(2),t);if("utf-16le"===t&&254===e[0]&&255===e[1]){if(1&e.length)throw new l("Expected even number of octets for 16-bit unicode string");return m(function(e){const t=e.length;if(1&t)throw new l("Buffer length must be even");for(let a=0;a<t;a+=2){const t=e[a];e[a]=e[a+1],e[a+1]=t}return e}(e),t)}return new a(e.length,t).get(e,0)}function f(e,t,a,r){const i=a%8;let s=e[t+~~(a/8)];s&=255>>i;const n=8-i,o=r-n;return o<0?s>>=8-i-r:o>0&&(s<<=o,s|=f(e,t,a+n,o)),s}function k(e,t,a){return 1===f(e,t,a,1)}var y,w,T;!function(e){e[e.Other=0]="Other",e[e["32x32 pixels 'file icon' (PNG only)"]=1]="32x32 pixels 'file icon' (PNG only)",e[e["Other file icon"]=2]="Other file icon",e[e["Cover (front)"]=3]="Cover (front)",e[e["Cover (back)"]=4]="Cover (back)",e[e["Leaflet page"]=5]="Leaflet page",e[e["Media (e.g. label side of CD)"]=6]="Media (e.g. label side of CD)",e[e["Lead artist/lead performer/soloist"]=7]="Lead artist/lead performer/soloist",e[e["Artist/performer"]=8]="Artist/performer",e[e.Conductor=9]="Conductor",e[e["Band/Orchestra"]=10]="Band/Orchestra",e[e.Composer=11]="Composer",e[e["Lyricist/text writer"]=12]="Lyricist/text writer",e[e["Recording Location"]=13]="Recording Location",e[e["During recording"]=14]="During recording",e[e["During performance"]=15]="During performance",e[e["Movie/video screen capture"]=16]="Movie/video screen capture",e[e["A bright coloured fish"]=17]="A bright coloured fish",e[e.Illustration=18]="Illustration",e[e["Band/artist logotype"]=19]="Band/artist logotype",e[e["Publisher/Studio logotype"]=20]="Publisher/Studio logotype"}(y||(y={})),function(e){e[e.other=0]="other",e[e.lyrics=1]="lyrics",e[e.text=2]="text",e[e.movement_part=3]="movement_part",e[e.events=4]="events",e[e.chord=5]="chord",e[e.trivia_pop=6]="trivia_pop"}(w||(w={})),function(e){e[e.notSynchronized0=0]="notSynchronized0",e[e.mpegFrameNumber=1]="mpegFrameNumber",e[e.milliseconds=2]="milliseconds"}(T||(T={}));const I={get:(e,t)=>127&e[t+3]|e[t+2]<<7|e[t+1]<<14|e[t]<<21,len:4},v={len:10,get:(e,a)=>({fileIdentifier:new t.StringType(3,"ascii").get(e,a),version:{major:t.INT8.get(e,a+3),revision:t.INT8.get(e,a+4)},flags:{unsynchronisation:p(e,a+5,7),isExtendedHeader:p(e,a+5,6),expIndicator:p(e,a+5,5),footer:p(e,a+5,4)},size:I.get(e,a+6)})},b={len:10,get:(e,a)=>({size:t.UINT32_BE.get(e,a),extendedFlags:t.UINT16_BE.get(e,a+4),sizeOfPadding:t.UINT32_BE.get(e,a+6),crcDataPresent:p(e,a+4,31)})},z=(e,t)=>{switch(e[t]){case 0:return{encoding:"latin1"};case 1:return{encoding:"utf-16le",bom:!0};case 2:return{encoding:"utf-16le",bom:!1};default:return{encoding:"utf8",bom:!1}}},P=4,E=(e,a)=>({encoding:z(e,a),language:new t.StringType(3,"latin1").get(e,a+1)}),F=6,D=(e,a)=>{const r=E(e,a);return{encoding:r.encoding,language:r.language,timeStampFormat:t.UINT8.get(e,a+4),contentType:t.UINT8.get(e,a+5)}};class x{constructor(e,t,a){this.metadata=e,this.tokenizer=t,this.options=a}}const L=/^[\x21-\x7eÂ©][\x20-\x7e\x00()]{3}/,S={len:4,get:(e,t)=>{const a=n(e.slice(t,t+S.len),"latin1");if(!a.match(L))throw new l(`FourCC contains invalid characters: ${function(e){const t=[];for(let a=0,r=e.length;a<r;a++){const r=Number(e.charCodeAt(a)).toString(16);t.push(1===r.length?`0${r}`:r)}return t.join(" ")}(a)} "${a}"`);return a},put:(e,t,a)=>{const r=o(a);if(4!==r.length)throw new h("Invalid length");return e.set(r,t),t+4}};var N;!function(e){e[e.text_utf8=0]="text_utf8",e[e.binary=1]="binary",e[e.external_info=2]="external_info",e[e.reserved=3]="reserved"}(N||(N={}));const C={len:52,get:(e,a)=>({ID:S.get(e,a),version:t.UINT32_LE.get(e,a+4)/1e3,descriptorBytes:t.UINT32_LE.get(e,a+8),headerBytes:t.UINT32_LE.get(e,a+12),seekTableBytes:t.UINT32_LE.get(e,a+16),headerDataBytes:t.UINT32_LE.get(e,a+20),apeFrameDataBytes:t.UINT32_LE.get(e,a+24),apeFrameDataBytesHigh:t.UINT32_LE.get(e,a+28),terminatingDataBytes:t.UINT32_LE.get(e,a+32),fileMD5:new t.Uint8ArrayType(16).get(e,a+36)})},A={len:24,get:(e,a)=>({compressionLevel:t.UINT16_LE.get(e,a),formatFlags:t.UINT16_LE.get(e,a+2),blocksPerFrame:t.UINT32_LE.get(e,a+4),finalFrameBlocks:t.UINT32_LE.get(e,a+8),totalFrames:t.UINT32_LE.get(e,a+12),bitsPerSample:t.UINT16_LE.get(e,a+16),channel:t.UINT16_LE.get(e,a+18),sampleRate:t.UINT32_LE.get(e,a+20)})},U={len:32,get:(e,a)=>({ID:new t.StringType(8,"ascii").get(e,a),version:t.UINT32_LE.get(e,a+8),size:t.UINT32_LE.get(e,a+12),fields:t.UINT32_LE.get(e,a+16),flags:_(t.UINT32_LE.get(e,a+20))})},B={len:8,get:(e,a)=>({size:t.UINT32_LE.get(e,a),flags:_(t.UINT32_LE.get(e,a+4))})};function _(e){return{containsHeader:H(e,31),containsFooter:H(e,30),isHeader:H(e,29),readOnly:H(e,0),dataType:(6&e)>>1}}function H(e,t){return!!(e&1<<t)}const R=e("music-metadata:parser:APEv2"),M="APEv2",$="APETAGEX";class O extends(u("APEv2")){}class G extends x{constructor(){super(...arguments),this.ape={}}static tryParseApeHeader(e,t,a){return new G(e,t,a).tryParseApeHeader()}static calculateDuration(e){let t=e.totalFrames>1?e.blocksPerFrame*(e.totalFrames-1):0;return t+=e.finalFrameBlocks,t/e.sampleRate}static async findApeFooterOffset(e,t){const a=new Uint8Array(U.len),r=e.position;await e.readBuffer(a,{position:t-U.len}),e.setPosition(r);const i=U.get(a,0);if("APETAGEX"===i.ID)return i.flags.isHeader?R("APE Header found at offset="+(t-U.len)):(R("APE Footer found at offset="+(t-U.len)),t-=i.size),{footer:i,offset:t}}static parseTagFooter(e,t,a){const r=U.get(t,t.length-U.len);if(r.ID!==$)throw new O("Unexpected APEv2 Footer ID preamble value");i.fromBuffer(t);return new G(e,i.fromBuffer(t),a).parseTags(r)}async tryParseApeHeader(){if(this.tokenizer.fileInfo.size&&this.tokenizer.fileInfo.size-this.tokenizer.position<U.len)return void R("No APEv2 header found, end-of-file reached");const e=await this.tokenizer.peekToken(U);if(e.ID===$)return await this.tokenizer.ignore(U.len),this.parseTags(e);if(R(`APEv2 header not found at offset=${this.tokenizer.position}`),this.tokenizer.fileInfo.size){const e=this.tokenizer.fileInfo.size-this.tokenizer.position,t=new Uint8Array(e);return await this.tokenizer.readBuffer(t),G.parseTagFooter(this.metadata,t,this.options)}}async parse(){const e=await this.tokenizer.readToken(C);if("MAC "!==e.ID)throw new O("Unexpected descriptor ID");this.ape.descriptor=e;const t=e.descriptorBytes-C.len,a=await(t>0?this.parseDescriptorExpansion(t):this.parseHeader());return await this.tokenizer.ignore(a.forwardBytes),this.tryParseApeHeader()}async parseTags(e){const t=new Uint8Array(256);let r=e.size-U.len;R(`Parse APE tags at offset=${this.tokenizer.position}, size=${r}`);for(let i=0;i<e.fields;i++){if(r<B.len){this.metadata.addWarning(`APEv2 Tag-header: ${e.fields-i} items remaining, but no more tag data to read.`);break}const s=await this.tokenizer.readToken(B);r-=B.len+s.size,await this.tokenizer.peekBuffer(t,{length:Math.min(t.length,r)});let o=g(t,0,t.length);const c=await this.tokenizer.readToken(new a(o,"ascii"));switch(await this.tokenizer.ignore(1),r-=c.length+1,s.flags.dataType){case N.text_utf8:{const e=(await this.tokenizer.readToken(new a(s.size,"utf8"))).split(/\x00/g);await Promise.all(e.map((e=>this.metadata.addTag(M,c,e))));break}case N.binary:if(this.options.skipCovers)await this.tokenizer.ignore(s.size);else{const e=new Uint8Array(s.size);await this.tokenizer.readBuffer(e),o=g(e,0,e.length);const t=n(e.slice(0,o)),a=e.slice(o+1);await this.metadata.addTag(M,c,{description:t,data:a})}break;case N.external_info:R(`Ignore external info ${c}`),await this.tokenizer.ignore(s.size);break;case N.reserved:R(`Ignore external info ${c}`),this.metadata.addWarning(`APEv2 header declares a reserved datatype for "${c}"`),await this.tokenizer.ignore(s.size)}}}async parseDescriptorExpansion(e){return await this.tokenizer.ignore(e),this.parseHeader()}async parseHeader(){const e=await this.tokenizer.readToken(A);if(this.metadata.setFormat("lossless",!0),this.metadata.setFormat("container","Monkey's Audio"),this.metadata.setFormat("bitsPerSample",e.bitsPerSample),this.metadata.setFormat("sampleRate",e.sampleRate),this.metadata.setFormat("numberOfChannels",e.channel),this.metadata.setFormat("duration",G.calculateDuration(e)),!this.ape.descriptor)throw new O("Missing APE descriptor");return{forwardBytes:this.ape.descriptor.seekTableBytes+this.ape.descriptor.headerDataBytes+this.ape.descriptor.apeFrameDataBytes+this.ape.descriptor.terminatingDataBytes}}}const V=e("music-metadata:parser:ID3v1"),j=["Blues","Classic Rock","Country","Dance","Disco","Funk","Grunge","Hip-Hop","Jazz","Metal","New Age","Oldies","Other","Pop","R&B","Rap","Reggae","Rock","Techno","Industrial","Alternative","Ska","Death Metal","Pranks","Soundtrack","Euro-Techno","Ambient","Trip-Hop","Vocal","Jazz+Funk","Fusion","Trance","Classical","Instrumental","Acid","House","Game","Sound Clip","Gospel","Noise","Alt. Rock","Bass","Soul","Punk","Space","Meditative","Instrumental Pop","Instrumental Rock","Ethnic","Gothic","Darkwave","Techno-Industrial","Electronic","Pop-Folk","Eurodance","Dream","Southern Rock","Comedy","Cult","Gangsta Rap","Top 40","Christian Rap","Pop/Funk","Jungle","Native American","Cabaret","New Wave","Psychedelic","Rave","Showtunes","Trailer","Lo-Fi","Tribal","Acid Punk","Acid Jazz","Polka","Retro","Musical","Rock & Roll","Hard Rock","Folk","Folk/Rock","National Folk","Swing","Fast-Fusion","Bebob","Latin","Revival","Celtic","Bluegrass","Avantgarde","Gothic Rock","Progressive Rock","Psychedelic Rock","Symphonic Rock","Slow Rock","Big Band","Chorus","Easy Listening","Acoustic","Humour","Speech","Chanson","Opera","Chamber Music","Sonata","Symphony","Booty Bass","Primus","Porn Groove","Satire","Slow Jam","Club","Tango","Samba","Folklore","Ballad","Power Ballad","Rhythmic Soul","Freestyle","Duet","Punk Rock","Drum Solo","A Cappella","Euro-House","Dance Hall","Goa","Drum & Bass","Club-House","Hardcore","Terror","Indie","BritPop","Negerpunk","Polsk Punk","Beat","Christian Gangsta Rap","Heavy Metal","Black Metal","Crossover","Contemporary Christian","Christian Rock","Merengue","Salsa","Thrash Metal","Anime","JPop","Synthpop","Abstract","Art Rock","Baroque","Bhangra","Big Beat","Breakbeat","Chillout","Downtempo","Dub","EBM","Eclectic","Electro","Electroclash","Emo","Experimental","Garage","Global","IDM","Illbient","Industro-Goth","Jam Band","Krautrock","Leftfield","Lounge","Math Rock","New Romantic","Nu-Breakz","Post-Punk","Post-Rock","Psytrance","Shoegaze","Space Rock","Trop Rock","World Music","Neoclassical","Audiobook","Audio Theatre","Neue Deutsche Welle","Podcast","Indie Rock","G-Funk","Dubstep","Garage Rock","Psybient"],W={len:128,get:(e,t)=>{const a=new X(3).get(e,t);return"TAG"===a?{header:a,title:new X(30).get(e,t+3),artist:new X(30).get(e,t+33),album:new X(30).get(e,t+63),year:new X(4).get(e,t+93),comment:new X(28).get(e,t+97),zeroByte:r.get(e,t+127),track:r.get(e,t+126),genre:r.get(e,t+127)}:null}};class X{constructor(e){this.len=e,this.stringType=new a(e,"latin1")}get(e,t){let a=this.stringType.get(e,t);return a=function(e){const t=e.indexOf("\0");return-1===t?e:e.substr(0,t)}(a),a=a.trim(),a.length>0?a:void 0}}class q extends x{constructor(e,t,a){super(e,t,a),this.apeHeader=a.apeHeader}static getGenre(e){if(e<j.length)return j[e]}async parse(){if(!this.tokenizer.fileInfo.size)return void V("Skip checking for ID3v1 because the file-size is unknown");if(this.apeHeader){this.tokenizer.ignore(this.apeHeader.offset-this.tokenizer.position);const e=new G(this.metadata,this.tokenizer,this.options);await e.parseTags(this.apeHeader.footer)}const e=this.tokenizer.fileInfo.size-W.len;if(this.tokenizer.position>e)return void V("Already consumed the last 128 bytes");const t=await this.tokenizer.readToken(W,e);if(t){V("ID3v1 header found at: pos=%s",this.tokenizer.fileInfo.size-W.len);const e=["title","artist","album","comment","track","year"];for(const a of e)t[a]&&""!==t[a]&&await this.addTag(a,t[a]);const a=q.getGenre(t.genre);a&&await this.addTag("genre",a)}else V("ID3v1 header not found at: pos=%s",this.tokenizer.fileInfo.size-W.len)}async addTag(e,t){await this.metadata.addTag("ID3v1",e,t)}}const J=e("music-metadata:id3v2:frame-parser"),K="latin1";function Y(e){return"RX"===e?"Remix":"CR"===e?"Cover":e.match(/^\d*$/)?j[Number.parseInt(e)]:void 0}class Z{constructor(e,t){this.major=e,this.warningCollector=t}readData(e,a,r){if(0===e.length)return void this.warningCollector.addWarning(`id3v2.${this.major} header has empty tag type=${a}`);const{encoding:i,bom:s}=z(e,0),n=e.length;let o=0,c=[];const d=Z.getNullTerminatorLength(i);let l;switch(J(`Parsing tag type=${a}, encoding=${i}, bom=${s}`),"TXXX"!==a&&"T"===a[0]?"T*":a){case"T*":case"GRP1":case"IPLS":case"MVIN":case"MVNM":case"PCS":case"PCST":{let t;try{t=m(e.slice(1),i).replace(/\x00+$/,"")}catch(e){if(e instanceof Error){this.warningCollector.addWarning(`id3v2.${this.major} type=${a} header has invalid string value: ${e.message}`);break}throw e}switch(a){case"TMCL":case"TIPL":case"IPLS":c=Z.functionList(this.splitValue(a,t));break;case"TRK":case"TRCK":case"TPOS":c=t;break;case"TCOM":case"TEXT":case"TOLY":case"TOPE":case"TPE1":case"TSRC":c=this.splitValue(a,t);break;case"TCO":case"TCON":c=this.splitValue(a,t).map((e=>function(e){const t=[];let a,r="";for(const i of e)if("string"==typeof a)if("("===i&&""===a)r+="(",a=void 0;else if(")"===i){""!==r&&(t.push(r),r="");const e=Y(a);e&&t.push(e),a=void 0}else a+=i;else"("===i?a="":r+=i;return r&&(0===t.length&&r.match(/^\d*$/)&&(r=Y(r)),r&&t.push(r)),t}(e))).reduce(((e,t)=>e.concat(t)),[]);break;case"PCS":case"PCST":c=this.major>=4?this.splitValue(a,t):[t],c=Array.isArray(c)&&""===c[0]?1:0;break;default:c=this.major>=4?this.splitValue(a,t):[t]}break}case"TXXX":{const t=Z.readIdentifierAndData(e,o+1,n,i);c={description:t.id,text:this.splitValue(a,m(t.data,i).replace(/\x00+$/,""))};break}case"PIC":case"APIC":if(r){const t={};switch(o+=1,this.major){case 2:t.format=m(e.slice(o,o+3),"latin1"),o+=3;break;case 3:case 4:l=g(e,o,n,K),t.format=m(e.slice(o,l),K),o=l+1;break;default:throw function(e){throw new Q(`Unexpected majorVer: ${e}`)}(this.major)}t.format=Z.fixPictureMimeType(t.format),t.type=y[e[o]],o+=1,l=g(e,o,n,i),t.description=m(e.slice(o,l),i),o=l+d,t.data=e.slice(o,n),c=t}break;case"CNT":case"PCNT":c=t.UINT32_BE.get(e,0);break;case"SYLT":{const a=D(e,0);o+=F;const r={descriptor:"",language:a.language,contentType:a.contentType,timeStampFormat:a.timeStampFormat,syncText:[]};let i=!1;for(;o<n;){const s=Z.readNullTerminatedString(e.subarray(o),a.encoding);if(o+=s.len,i){const a=t.UINT32_BE.get(e,o);o+=t.UINT32_BE.len,r.syncText.push({text:s.text,timestamp:a})}else r.descriptor=s.text,i=!0}c=r;break}case"ULT":case"USLT":case"COM":case"COMM":{const t=E(e,o);o+=P;const a=Z.readNullTerminatedString(e.subarray(o),t.encoding);o+=a.len;const r=Z.readNullTerminatedString(e.subarray(o),t.encoding);c={language:t.language,descriptor:a.text,text:r.text};break}case"UFID":{const t=Z.readIdentifierAndData(e,o,n,K);c={owner_identifier:t.id,identifier:t.data};break}case"PRIV":{const t=Z.readIdentifierAndData(e,o,n,K);c={owner_identifier:t.id,data:t.data};break}case"POPM":{l=g(e,o,n,K);const a=m(e.slice(o,l),K);o=l+1;const r=n-o;c={email:a,rating:t.UINT8.get(e,o),counter:r>=5?t.UINT32_BE.get(e,o+1):void 0};break}case"GEOB":{l=g(e,o+1,n,i);const t=m(e.slice(o+1,l),K);o=l+1,l=g(e,o,n,i);const a=m(e.slice(o,l),K);o=l+1,l=g(e,o,n,i);const r=m(e.slice(o,l),K);o=l+1;c={type:t,filename:a,description:r,data:e.slice(o,n)};break}case"WCOM":case"WCOP":case"WOAF":case"WOAR":case"WOAS":case"WORS":case"WPAY":case"WPUB":l=g(e,o+1,n,i),c=m(e.slice(o,l),K);break;case"WXXX":{l=g(e,o+1,n,i);const t=m(e.slice(o+1,l),i);o=l+("utf-16le"===i?2:1),c={description:t,url:m(e.slice(o,n),K)};break}case"WFD":case"WFED":c=m(e.slice(o+1,g(e,o+1,n,i)),i);break;case"MCDI":c=e.slice(0,n);break;default:J(`Warning: unsupported id3v2-tag-type: ${a}`)}return c}static readNullTerminatedString(e,t){let a=t.bom?2:0;const r=g(e,a,e.length,t.encoding),i=e.slice(a,r);return a="utf-16le"===t.encoding?r+2:r+1,{text:m(i,t.encoding),len:a}}static fixPictureMimeType(e){switch(e=e.toLocaleLowerCase()){case"jpg":return"image/jpeg";case"png":return"image/png"}return e}static functionList(e){const t={};for(let a=0;a+1<e.length;a+=2){const r=e[a+1].split(",");t[e[a]]=t[e[a]]?t[e[a]].concat(r):r}return t}splitValue(e,t){let a;return this.major<4?(a=t.split(/\x00/g),a.length>1?this.warningCollector.addWarning(`ID3v2.${this.major} ${e} uses non standard null-separator.`):a=t.split(/\//g)):a=t.split(/\x00/g),Z.trimArray(a)}static trimArray(e){return e.map((e=>e.replace(/\x00+$/,"").trim()))}static readIdentifierAndData(e,t,a,r){const i=g(e,t,a,r),s=m(e.slice(t,i),r);return t=i+Z.getNullTerminatorLength(r),{id:s,data:e.slice(t,a)}}static getNullTerminatorLength(e){return"utf-16le"===e?2:1}}class Q extends(u("id3v2")){}const ee=new TextDecoder("ascii");class te{constructor(){this.tokenizer=void 0,this.id3Header=void 0,this.metadata=void 0,this.headerType=void 0,this.options=void 0}static removeUnsyncBytes(e){let t=0,a=0;for(;t<e.length-1;)t!==a&&(e[a]=e[t]),t+=255===e[t]&&0===e[t+1]?2:1,a++;return t<e.length&&(e[a++]=e[t]),e.slice(0,a)}static getFrameHeaderLength(e){switch(e){case 2:return 6;case 3:case 4:return 10;default:throw ae(e)}}static readFrameFlags(e){return{status:{tag_alter_preservation:p(e,0,6),file_alter_preservation:p(e,0,5),read_only:p(e,0,4)},format:{grouping_identity:p(e,1,7),compression:p(e,1,3),encryption:p(e,1,2),unsynchronisation:p(e,1,1),data_length_indicator:p(e,1,0)}}}static readFrameData(e,t,a,r,i){const s=new Z(a,i);switch(a){case 2:return s.readData(e,t.id,r);case 3:case 4:return t.flags?.format.unsynchronisation&&(e=te.removeUnsyncBytes(e)),t.flags?.format.data_length_indicator&&(e=e.slice(4,e.length)),s.readData(e,t.id,r);default:throw ae(a)}}static makeDescriptionTagName(e,t){return e+(t?`:${t}`:"")}async parse(e,t,a){this.tokenizer=t,this.metadata=e,this.options=a;const r=await this.tokenizer.readToken(v);if("ID3"!==r.fileIdentifier)throw new Q("expected ID3-header file-identifier 'ID3' was not found");return this.id3Header=r,this.headerType=`ID3v2.${r.version.major}`,r.flags.isExtendedHeader?this.parseExtendedHeader():this.parseId3Data(r.size)}async parseExtendedHeader(){const e=await this.tokenizer.readToken(b),t=e.size-b.len;return t>0?this.parseExtendedHeaderData(t,e.size):this.parseId3Data(this.id3Header.size-e.size)}async parseExtendedHeaderData(e,t){return await this.tokenizer.ignore(e),this.parseId3Data(this.id3Header.size-t)}async parseId3Data(e){const a=await this.tokenizer.readToken(new t.Uint8ArrayType(e));for(const e of this.parseMetadata(a))if("TXXX"===e.id)e.value&&await this.handleTag(e,e.value.text,(()=>e.value.description));else await(Array.isArray(e.value)?Promise.all(e.value.map((t=>this.addTag(e.id,t)))):this.addTag(e.id,e.value))}async handleTag(e,t,a,r=e=>e){await Promise.all(t.map((t=>this.addTag(te.makeDescriptionTagName(e.id,a(t)),r(t)))))}async addTag(e,t){await this.metadata.addTag(this.headerType,e,t)}parseMetadata(e){let t=0;const a=[];for(;t!==e.length;){const r=te.getFrameHeaderLength(this.id3Header.version.major);if(t+r>e.length){this.metadata.addWarning("Illegal ID3v2 tag length");break}const i=e.slice(t,t+r);t+=r;const s=this.readFrameHeader(i,this.id3Header.version.major),n=e.slice(t,t+s.length);t+=s.length;const o=te.readFrameData(n,s,this.id3Header.version.major,!this.options.skipCovers,this.metadata);o&&a.push({id:s.id,value:o})}return a}readFrameHeader(e,a){let r;switch(a){case 2:r={id:ee.decode(e.slice(0,3)),length:t.UINT24_BE.get(e,3)},r.id.match(/[A-Z0-9]{3}/g)||this.metadata.addWarning(`Invalid ID3v2.${this.id3Header.version.major} frame-header-ID: ${r.id}`);break;case 3:case 4:r={id:ee.decode(e.slice(0,4)),length:(4===a?I:t.UINT32_BE).get(e,4),flags:te.readFrameFlags(e.slice(8,10))},r.id.match(/[A-Z0-9]{4}/g)||this.metadata.addWarning(`Invalid ID3v2.${this.id3Header.version.major} frame-header-ID: ${r.id}`);break;default:throw ae(a)}return r}}function ae(e){throw new Q(`Unexpected majorVer: ${e}`)}const re=e("music-metadata:parser:ID3");class ie extends x{constructor(){super(...arguments),this.id3parser=new te}static async startsWithID3v2Header(e){return"ID3"===(await e.peekToken(v)).fileIdentifier}async parse(){try{await this.parseID3v2()}catch(e){if(!(e instanceof s))throw e;re("End-of-stream")}}finalize(){}async parseID3v2(){if(await this.tryReadId3v2Headers(),re("End of ID3v2 header, go to MPEG-parser: pos=%s",this.tokenizer.position),await this.postId3v2Parse(),this.options.skipPostHeaders&&this.metadata.hasAny())this.finalize();else{const e=new q(this.metadata,this.tokenizer,this.options);await e.parse(),this.finalize()}}async tryReadId3v2Headers(){if("ID3"===(await this.tokenizer.peekToken(v)).fileIdentifier)return re("Found ID3v2 header, pos=%s",this.tokenizer.position),await this.id3parser.parse(this.metadata,this.tokenizer,this.options),this.tryReadId3v2Headers()}}const se=e("music-metadata:parser:musepack:sv8"),ne=new t.StringType(2,"latin1"),oe={len:5,get:(e,a)=>({crc:t.UINT32_LE.get(e,a),streamVersion:t.UINT8.get(e,a+4)})},ce={len:2,get:(e,t)=>({sampleFrequency:[44100,48e3,37800,32e3][f(e,t,0,3)],maxUsedBands:f(e,t,3,5),channelCount:f(e,t+1,0,4)+1,msUsed:k(e,t+1,4),audioBlockFrames:f(e,t+1,5,3)})};class de{constructor(e){this.tokenizer=e}async readPacketHeader(){const e=await this.tokenizer.readToken(ne),t=await this.readVariableSizeField();return{key:e,payloadLength:t.value-2-t.len}}async readStreamHeader(e){const t={};se(`Reading SH at offset=${this.tokenizer.position}`);const a=await this.tokenizer.readToken(oe);e-=oe.len,Object.assign(t,a),se(`SH.streamVersion = ${a.streamVersion}`);const r=await this.readVariableSizeField();e-=r.len,t.sampleCount=r.value;const i=await this.readVariableSizeField();e-=i.len,t.beginningOfSilence=i.value;const s=await this.tokenizer.readToken(ce);return e-=ce.len,Object.assign(t,s),await this.tokenizer.ignore(e),t}async readVariableSizeField(e=1,a=0){let r=await this.tokenizer.readNumber(t.UINT8);return 128&r?(r&=127,r+=a,this.readVariableSizeField(e+1,r<<7)):{len:e,value:a+r}}}class le extends(u("Musepack")){}const he=e("music-metadata:parser:musepack");class ue extends x{constructor(){super(...arguments),this.audioLength=0}async parse(){if("MPCK"!==await this.tokenizer.readToken(S))throw new le("Invalid Magic number");return this.metadata.setFormat("container","Musepack, SV8"),this.parsePacket()}async parsePacket(){const e=new de(this.tokenizer);for(;;){const t=await e.readPacketHeader();switch(he(`packet-header key=${t.key}, payloadLength=${t.payloadLength}`),t.key){case"SH":{const a=await e.readStreamHeader(t.payloadLength);this.metadata.setFormat("numberOfSamples",a.sampleCount),this.metadata.setFormat("sampleRate",a.sampleFrequency),this.metadata.setFormat("duration",a.sampleCount/a.sampleFrequency),this.metadata.setFormat("numberOfChannels",a.channelCount);break}case"AP":this.audioLength+=t.payloadLength,await this.tokenizer.ignore(t.payloadLength);break;case"RG":case"EI":case"SO":case"ST":case"CT":await this.tokenizer.ignore(t.payloadLength);break;case"SE":return this.metadata.format.duration&&this.metadata.setFormat("bitrate",8*this.audioLength/this.metadata.format.duration),G.tryParseApeHeader(this.metadata,this.tokenizer,this.options);default:throw new le(`Unexpected header: ${t.key}`)}}}}class pe{constructor(e){this.tokenizer=e,this.pos=0,this.dword=null}async read(e){for(;null===this.dword;)this.dword=await this.tokenizer.readToken(t.UINT32_LE);let a=this.dword;return this.pos+=e,this.pos<32?(a>>>=32-this.pos,a&(1<<e)-1):(this.pos-=32,0===this.pos?(this.dword=null,a&(1<<e)-1):(this.dword=await this.tokenizer.readToken(t.UINT32_LE),this.pos&&(a<<=this.pos,a|=this.dword>>>32-this.pos),a&(1<<e)-1))}async ignore(e){if(this.pos>0){const t=32-this.pos;this.dword=null,e-=t,this.pos=0}const t=e%32,a=(e-t)/32;return await this.tokenizer.ignore(4*a),this.read(t)}}const ge={len:24,get:(e,a)=>{const r={signature:new TextDecoder("latin1").decode(e.subarray(a,a+3)),streamMinorVersion:f(e,a+3,0,4),streamMajorVersion:f(e,a+3,4,4),frameCount:t.UINT32_LE.get(e,a+4),maxLevel:t.UINT16_LE.get(e,a+8),sampleFrequency:[44100,48e3,37800,32e3][f(e,a+10,0,2)],link:f(e,a+10,2,2),profile:f(e,a+10,4,4),maxBand:f(e,a+11,0,6),intensityStereo:k(e,a+11,6),midSideStereo:k(e,a+11,7),titlePeak:t.UINT16_LE.get(e,a+12),titleGain:t.UINT16_LE.get(e,a+14),albumPeak:t.UINT16_LE.get(e,a+16),albumGain:t.UINT16_LE.get(e,a+18),lastFrameLength:t.UINT32_LE.get(e,a+20)>>>20&2047,trueGapless:k(e,a+23,0)};return r.lastFrameLength=r.trueGapless?t.UINT32_LE.get(e,20)>>>20&2047:0,r}},me=e("music-metadata:parser:musepack");class fe extends x{constructor(){super(...arguments),this.bitreader=null,this.audioLength=0,this.duration=null}async parse(){const e=await this.tokenizer.readToken(ge);if("MP+"!==e.signature)throw new le("Unexpected magic number");me(`stream-version=${e.streamMajorVersion}.${e.streamMinorVersion}`),this.metadata.setFormat("container","Musepack, SV7"),this.metadata.setFormat("sampleRate",e.sampleFrequency);const t=1152*(e.frameCount-1)+e.lastFrameLength;this.metadata.setFormat("numberOfSamples",t),this.duration=t/e.sampleFrequency,this.metadata.setFormat("duration",this.duration),this.bitreader=new pe(this.tokenizer),this.metadata.setFormat("numberOfChannels",e.midSideStereo||e.intensityStereo?2:1);const a=await this.bitreader.read(8);return this.metadata.setFormat("codec",(a/100).toFixed(2)),await this.skipAudioData(e.frameCount),me(`End of audio stream, switching to APEv2, offset=${this.tokenizer.position}`),G.tryParseApeHeader(this.metadata,this.tokenizer,this.options)}async skipAudioData(e){for(;e-- >0;){const e=await this.bitreader.read(20);this.audioLength+=20+e,await this.bitreader.ignore(e)}const t=await this.bitreader.read(11);this.audioLength+=t,null!==this.duration&&this.metadata.setFormat("bitrate",this.audioLength/this.duration)}}const ke=e("music-metadata:parser:musepack");class ye extends ie{async postId3v2Parse(){let e;switch(await this.tokenizer.peekToken(new t.StringType(3,"latin1"))){case"MP+":ke("Stream-version 7"),e=new fe(this.metadata,this.tokenizer,this.options);break;case"MPC":ke("Stream-version 8"),e=new ue(this.metadata,this.tokenizer,this.options);break;default:throw new le("Invalid signature prefix")}return e.parse()}}export{ye as MusepackParser};export default null;