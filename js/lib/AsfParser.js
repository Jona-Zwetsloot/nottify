import e from"./debug.js";import*as t from"./token-types.js";import{StringType as n}from"./token-types.js";import{uint8ArrayToHex as r,hexToUint8Array as a}from"./uint8array-extras.js";var i,o;!function(e){e[e.shot=10]="shot",e[e.scene=20]="scene",e[e.track=30]="track",e[e.part=40]="part",e[e.album=50]="album",e[e.edition=60]="edition",e[e.collection=70]="collection"}(i||(i={})),function(e){e[e.video=1]="video",e[e.audio=2]="audio",e[e.complex=3]="complex",e[e.logo=4]="logo",e[e.subtitle=17]="subtitle",e[e.button=18]="button",e[e.control=32]="control"}(o||(o={}));const s=e=>class extends Error{constructor(t){super(t),this.name=e}};class c extends(s("UnexpectedFileContentError")){constructor(e,t){super(t),this.fileType=e}toString(){return`${this.name} (FileType: ${this.fileType}): ${this.message}`}}class d extends(s("FieldDecodingError")){}const u=e=>class extends c{constructor(t){super(e,t)}};function l(e,t,n){return!!(e[t]&1<<n)}function g(e,t){if(255===e[0]&&254===e[1])return g(e.subarray(2),t);if("utf-16le"===t&&254===e[0]&&255===e[1]){if(1&e.length)throw new d("Expected even number of octets for 16-bit unicode string");return g(function(e){const t=e.length;if(1&t)throw new d("Buffer length must be even");for(let n=0;n<t;n+=2){const t=e[n];e[n]=e[n+1],e[n+1]=t}return e}(e),t)}return new n(e.length,t).get(e,0)}var b,m,C;!function(e){e[e.Other=0]="Other",e[e["32x32 pixels 'file icon' (PNG only)"]=1]="32x32 pixels 'file icon' (PNG only)",e[e["Other file icon"]=2]="Other file icon",e[e["Cover (front)"]=3]="Cover (front)",e[e["Cover (back)"]=4]="Cover (back)",e[e["Leaflet page"]=5]="Leaflet page",e[e["Media (e.g. label side of CD)"]=6]="Media (e.g. label side of CD)",e[e["Lead artist/lead performer/soloist"]=7]="Lead artist/lead performer/soloist",e[e["Artist/performer"]=8]="Artist/performer",e[e.Conductor=9]="Conductor",e[e["Band/Orchestra"]=10]="Band/Orchestra",e[e.Composer=11]="Composer",e[e["Lyricist/text writer"]=12]="Lyricist/text writer",e[e["Recording Location"]=13]="Recording Location",e[e["During recording"]=14]="During recording",e[e["During performance"]=15]="During performance",e[e["Movie/video screen capture"]=16]="Movie/video screen capture",e[e["A bright coloured fish"]=17]="A bright coloured fish",e[e.Illustration=18]="Illustration",e[e["Band/artist logotype"]=19]="Band/artist logotype",e[e["Publisher/Studio logotype"]=20]="Publisher/Studio logotype"}(b||(b={})),function(e){e[e.other=0]="other",e[e.lyrics=1]="lyrics",e[e.text=2]="text",e[e.movement_part=3]="movement_part",e[e.events=4]="events",e[e.chord=5]="chord",e[e.trivia_pop=6]="trivia_pop"}(m||(m={})),function(e){e[e.notSynchronized0=0]="notSynchronized0",e[e.mpegFrameNumber=1]="mpegFrameNumber",e[e.milliseconds=2]="milliseconds"}(C||(C={}));class w{static fromBin(e,t=0){return new w(w.decode(e,t))}static decode(e,t=0){const n=new DataView(e.buffer,t);return`${n.getUint32(0,!0).toString(16)}-${n.getUint16(4,!0).toString(16)}-${n.getUint16(6,!0).toString(16)}-${n.getUint16(8).toString(16)}-${r(e.slice(t+10,t+16))}`.toUpperCase()}static decodeMediaType(e){switch(e.str){case w.AudioMedia.str:return"audio";case w.VideoMedia.str:return"video";case w.CommandMedia.str:return"command";case w.Degradable_JPEG_Media.str:return"degradable-jpeg";case w.FileTransferMedia.str:return"file-transfer";case w.BinaryMedia.str:return"binary"}}static encode(e){const t=new Uint8Array(16),n=new DataView(t.buffer);return n.setUint32(0,Number.parseInt(e.slice(0,8),16),!0),n.setUint16(4,Number.parseInt(e.slice(9,13),16),!0),n.setUint16(6,Number.parseInt(e.slice(14,18),16),!0),t.set(a(e.slice(19,23)),8),t.set(a(e.slice(24)),10),t}constructor(e){this.str=e}equals(e){return this.str===e.str}toBin(){return w.encode(this.str)}}function f(e){return g(e,"utf-16le").replace(/^\x00+/g,"").replace(/\x00+$/g,"")}w.HeaderObject=new w("75B22630-668E-11CF-A6D9-00AA0062CE6C"),w.DataObject=new w("75B22636-668E-11CF-A6D9-00AA0062CE6C"),w.SimpleIndexObject=new w("33000890-E5B1-11CF-89F4-00A0C90349CB"),w.IndexObject=new w("D6E229D3-35DA-11D1-9034-00A0C90349BE"),w.MediaObjectIndexObject=new w("FEB103F8-12AD-4C64-840F-2A1D2F7AD48C"),w.TimecodeIndexObject=new w("3CB73FD0-0C4A-4803-953D-EDF7B6228F0C"),w.FilePropertiesObject=new w("8CABDCA1-A947-11CF-8EE4-00C00C205365"),w.StreamPropertiesObject=new w("B7DC0791-A9B7-11CF-8EE6-00C00C205365"),w.HeaderExtensionObject=new w("5FBF03B5-A92E-11CF-8EE3-00C00C205365"),w.CodecListObject=new w("86D15240-311D-11D0-A3A4-00A0C90348F6"),w.ScriptCommandObject=new w("1EFB1A30-0B62-11D0-A39B-00A0C90348F6"),w.MarkerObject=new w("F487CD01-A951-11CF-8EE6-00C00C205365"),w.BitrateMutualExclusionObject=new w("D6E229DC-35DA-11D1-9034-00A0C90349BE"),w.ErrorCorrectionObject=new w("75B22635-668E-11CF-A6D9-00AA0062CE6C"),w.ContentDescriptionObject=new w("75B22633-668E-11CF-A6D9-00AA0062CE6C"),w.ExtendedContentDescriptionObject=new w("D2D0A440-E307-11D2-97F0-00A0C95EA850"),w.ContentBrandingObject=new w("2211B3FA-BD23-11D2-B4B7-00A0C955FC6E"),w.StreamBitratePropertiesObject=new w("7BF875CE-468D-11D1-8D82-006097C9A2B2"),w.ContentEncryptionObject=new w("2211B3FB-BD23-11D2-B4B7-00A0C955FC6E"),w.ExtendedContentEncryptionObject=new w("298AE614-2622-4C17-B935-DAE07EE9289C"),w.DigitalSignatureObject=new w("2211B3FC-BD23-11D2-B4B7-00A0C955FC6E"),w.PaddingObject=new w("1806D474-CADF-4509-A4BA-9AABCB96AAE8"),w.ExtendedStreamPropertiesObject=new w("14E6A5CB-C672-4332-8399-A96952065B5A"),w.AdvancedMutualExclusionObject=new w("A08649CF-4775-4670-8A16-6E35357566CD"),w.GroupMutualExclusionObject=new w("D1465A40-5A79-4338-B71B-E36B8FD6C249"),w.StreamPrioritizationObject=new w("D4FED15B-88D3-454F-81F0-ED5C45999E24"),w.BandwidthSharingObject=new w("A69609E6-517B-11D2-B6AF-00C04FD908E9"),w.LanguageListObject=new w("7C4346A9-EFE0-4BFC-B229-393EDE415C85"),w.MetadataObject=new w("C5F8CBEA-5BAF-4877-8467-AA8C44FA4CCA"),w.MetadataLibraryObject=new w("44231C94-9498-49D1-A141-1D134E457054"),w.IndexParametersObject=new w("D6E229DF-35DA-11D1-9034-00A0C90349BE"),w.MediaObjectIndexParametersObject=new w("6B203BAD-3F11-48E4-ACA8-D7613DE2CFA7"),w.TimecodeIndexParametersObject=new w("F55E496D-9797-4B5D-8C8B-604DFE9BFB24"),w.CompatibilityObject=new w("26F18B5D-4584-47EC-9F5F-0E651F0452C9"),w.AdvancedContentEncryptionObject=new w("43058533-6981-49E6-9B74-AD12CB86D58C"),w.AudioMedia=new w("F8699E40-5B4D-11CF-A8FD-00805F5C442B"),w.VideoMedia=new w("BC19EFC0-5B4D-11CF-A8FD-00805F5C442B"),w.CommandMedia=new w("59DACFC0-59E6-11D0-A3AC-00A0C90348F6"),w.JFIF_Media=new w("B61BE100-5B4E-11CF-A8FD-00805F5C442B"),w.Degradable_JPEG_Media=new w("35907DE0-E415-11CF-A917-00805F5C442B"),w.FileTransferMedia=new w("91BD222C-F21C-497A-8B6D-5AA86BFC0185"),w.BinaryMedia=new w("3AFB65E2-47EF-40F2-AC2C-70A90D71D343"),w.ASF_Index_Placeholder_Object=new w("D9AADE20-7C17-4F9C-BC28-8555DD98E2A2");const D=[f,p,function(e,t=0){return 1===E(e,t)},function(e,n=0){return t.UINT32_LE.get(e,n)},function(e,n=0){return t.UINT64_LE.get(e,n)},E,p];function p(e){return new Uint8Array(e)}function E(e,n=0){return t.UINT16_LE.get(e,n)}class A extends(u("ASF")){}var B;!function(e){e[e.UnicodeString=0]="UnicodeString",e[e.ByteArray=1]="ByteArray",e[e.Bool=2]="Bool",e[e.DWord=3]="DWord",e[e.QWord=4]="QWord",e[e.Word=5]="Word"}(B||(B={}));const F={len:30,get:(e,n)=>({objectId:w.fromBin(e,n),objectSize:Number(t.UINT64_LE.get(e,n+16)),numberOfHeaderObjects:t.UINT32_LE.get(e,n+24)})},h={len:24,get:(e,n)=>({objectId:w.fromBin(e,n),objectSize:Number(t.UINT64_LE.get(e,n+16))})};class j{constructor(e){this.len=Number(e.objectSize)-h.len}postProcessTag(e,t,n,r){if("WM/Picture"===t)e.push({id:t,value:M.fromBuffer(r)});else{const a=D[n];if(!a)throw new A(`unexpected value headerType: ${n}`);e.push({id:t,value:a(r)})}}}class O extends j{get(e,t){return null}}class I extends j{get(e,n){return{fileId:w.fromBin(e,n),fileSize:t.UINT64_LE.get(e,n+16),creationDate:t.UINT64_LE.get(e,n+24),dataPacketsCount:t.UINT64_LE.get(e,n+32),playDuration:t.UINT64_LE.get(e,n+40),sendDuration:t.UINT64_LE.get(e,n+48),preroll:t.UINT64_LE.get(e,n+56),flags:{broadcast:l(e,n+64,24),seekable:l(e,n+64,25)},minimumDataPacketSize:t.UINT32_LE.get(e,n+68),maximumDataPacketSize:t.UINT32_LE.get(e,n+72),maximumBitrate:t.UINT32_LE.get(e,n+76)}}}I.guid=w.FilePropertiesObject;class y extends j{get(e,t){return{streamType:w.decodeMediaType(w.fromBin(e,t)),errorCorrectionType:w.fromBin(e,t+8)}}}y.guid=w.StreamPropertiesObject;class T{constructor(){this.len=22}get(e,t){const n=new DataView(e.buffer,t);return{reserved1:w.fromBin(e,t),reserved2:n.getUint16(16,!0),extensionDataSize:n.getUint16(18,!0)}}}T.guid=w.HeaderExtensionObject;const x={len:20,get:(e,t)=>({entryCount:new DataView(e.buffer,t).getUint16(16,!0)})};async function k(e){const n=await e.readNumber(t.UINT16_LE);return(await e.readToken(new t.StringType(2*n,"utf-16le"))).replace("\0","")}async function U(e){const t=await e.readToken(x),n=[];for(let r=0;r<t.entryCount;++r)n.push(await N(e));return n}async function S(e){const n=await e.readNumber(t.UINT16_LE),r=new Uint8Array(n);return await e.readBuffer(r),r}async function N(e){const n=await e.readNumber(t.UINT16_LE);return{type:{videoCodec:!(1&~n),audioCodec:!(2&~n)},codecName:await k(e),description:await k(e),information:await S(e)}}class z extends j{get(e,t){const n=[],r=new DataView(e.buffer,t);let a=10;for(let i=0;i<z.contentDescTags.length;++i){const o=r.getUint16(2*i,!0);if(o>0){const r=z.contentDescTags[i],s=a+o;n.push({id:r,value:f(e.slice(t+a,t+s))}),a=s}}return n}}z.guid=w.ContentDescriptionObject,z.contentDescTags=["Title","Author","Copyright","Description","Rating"];class v extends j{get(e,t){const n=[],r=new DataView(e.buffer,t),a=r.getUint16(0,!0);let i=2;for(let o=0;o<a;o+=1){const a=r.getUint16(i,!0);i+=2;const o=f(e.slice(t+i,t+i+a));i+=a;const s=r.getUint16(i,!0);i+=2;const c=r.getUint16(i,!0);i+=2;const d=e.slice(t+i,t+i+c);i+=c,this.postProcessTag(n,o,s,d)}return n}}v.guid=w.ExtendedContentDescriptionObject;class L extends j{get(e,n){const r=new DataView(e.buffer,n);return{startTime:t.UINT64_LE.get(e,n),endTime:t.UINT64_LE.get(e,n+8),dataBitrate:r.getInt32(12,!0),bufferSize:r.getInt32(16,!0),initialBufferFullness:r.getInt32(20,!0),alternateDataBitrate:r.getInt32(24,!0),alternateBufferSize:r.getInt32(28,!0),alternateInitialBufferFullness:r.getInt32(32,!0),maximumObjectSize:r.getInt32(36,!0),flags:{reliableFlag:l(e,n+40,0),seekableFlag:l(e,n+40,1),resendLiveCleanpointsFlag:l(e,n+40,2)},streamNumber:r.getInt16(42,!0),streamLanguageId:r.getInt16(44,!0),averageTimePerFrame:r.getInt32(52,!0),streamNameCount:r.getInt32(54,!0),payloadExtensionSystems:r.getInt32(56,!0),streamNames:[],streamPropertiesObject:null}}}L.guid=w.ExtendedStreamPropertiesObject;class _ extends j{get(e,t){const n=[],r=new DataView(e.buffer,t),a=r.getUint16(0,!0);let i=2;for(let o=0;o<a;o+=1){i+=4;const a=r.getUint16(i,!0);i+=2;const o=r.getUint16(i,!0);i+=2;const s=r.getUint32(i,!0);i+=4;const c=f(e.slice(t+i,t+i+a));i+=a;const d=e.slice(t+i,t+i+s);i+=s,this.postProcessTag(n,c,o,d)}return n}}_.guid=w.MetadataObject;class P extends _{}P.guid=w.MetadataLibraryObject;class M{static fromBuffer(e){return new M(e.length).get(e,0)}constructor(e){this.len=e}get(e,n){const r=new DataView(e.buffer,n),a=r.getUint8(0),i=r.getInt32(1,!0);let o=5;for(;0!==r.getUint16(o);)o+=2;const s=new t.StringType(o-5,"utf-16le").get(e,5);for(;0!==r.getUint16(o);)o+=2;const c=new t.StringType(o-5,"utf-16le").get(e,5);return{type:b[a],format:s,description:c,size:i,data:e.slice(o+4)}}}class ${constructor(e,t,n){this.metadata=e,this.tokenizer=t,this.options=n}}const V=e("music-metadata:parser:ASF");class G extends ${async parse(){const e=await this.tokenizer.readToken(F);if(!e.objectId.equals(w.HeaderObject))throw new A(`expected asf header; but was not found; got: ${e.objectId.str}`);try{await this.parseObjectHeader(e.numberOfHeaderObjects)}catch(e){V("Error while parsing ASF: %s",e)}}async parseObjectHeader(e){let t;do{const e=await this.tokenizer.readToken(h);switch(V("header GUID=%s",e.objectId.str),e.objectId.str){case I.guid.str:{const t=await this.tokenizer.readToken(new I(e));this.metadata.setFormat("duration",Number(t.playDuration/BigInt(1e3))/1e4-Number(t.preroll)/1e3),this.metadata.setFormat("bitrate",t.maximumBitrate);break}case y.guid.str:{const t=await this.tokenizer.readToken(new y(e));this.metadata.setFormat("container",`ASF/${t.streamType}`);break}case T.guid.str:{const e=await this.tokenizer.readToken(new T);await this.parseExtensionObject(e.extensionDataSize);break}case z.guid.str:t=await this.tokenizer.readToken(new z(e)),await this.addTags(t);break;case v.guid.str:t=await this.tokenizer.readToken(new v(e)),await this.addTags(t);break;case w.CodecListObject.str:{const e=await U(this.tokenizer);e.forEach((e=>{this.metadata.addStreamInfo({type:e.type.videoCodec?o.video:o.audio,codecName:e.codecName})}));const t=e.filter((e=>e.type.audioCodec)).map((e=>e.codecName)).join("/");this.metadata.setFormat("codec",t);break}case w.StreamBitratePropertiesObject.str:await this.tokenizer.ignore(e.objectSize-h.len);break;case w.PaddingObject.str:V("Padding: %s bytes",e.objectSize-h.len),await this.tokenizer.ignore(e.objectSize-h.len);break;default:this.metadata.addWarning(`Ignore ASF-Object-GUID: ${e.objectId.str}`),V("Ignore ASF-Object-GUID: %s",e.objectId.str),await this.tokenizer.readToken(new O(e))}}while(--e)}async addTags(e){await Promise.all(e.map((({id:e,value:t})=>this.metadata.addTag("asf",e,t))))}async parseExtensionObject(e){do{const t=await this.tokenizer.readToken(h),n=t.objectSize-h.len;switch(t.objectId.str){case L.guid.str:await this.tokenizer.readToken(new L(t));break;case _.guid.str:{const e=await this.tokenizer.readToken(new _(t));await this.addTags(e);break}case P.guid.str:{const e=await this.tokenizer.readToken(new P(t));await this.addTags(e);break}case w.PaddingObject.str:case w.CompatibilityObject.str:case w.ASF_Index_Placeholder_Object.str:await this.tokenizer.ignore(n);break;default:this.metadata.addWarning(`Ignore ASF-Object-GUID: ${t.objectId.str}`),await this.tokenizer.readToken(new O(t))}e-=t.objectSize}while(e>0)}}export{G as AsfParser};export default null;